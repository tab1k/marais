{% extends 'base.html' %}
{% load static %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å ‚Äî MARAIS{% endblock %}

{% block content %}

<section class="profile-page">
  <div class="container-m">
    <div class="profile-header">
      <div class="profile-user">
        <div class="profile-avatar">
          {% if request.user.is_authenticated and request.user.avatar %}
          <img src="{{ request.user.avatar.url }}" alt="{{ request.user.get_full_name|default:request.user.username }}">
          {% else %}
          <img src="{% static 'images/zaglushka.png' %}" alt="–ê–≤–∞—Ç–∞—Ä">
          {% endif %}
        </div>
        <div class="profile-user__meta">
          <p class="profile-greet">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</p>
          <h2 class="profile-name">
            {% if request.user.is_authenticated %}
            {{ request.user.get_full_name|default:request.user.username }}
            {% else %}
            –ì–æ—Å—Ç—å
            {% endif %}
          </h2>
        </div>
      </div>
      <div class="profile-header__actions">
        <button type="button" class="profile-icon-btn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" data-profile-settings-open>
          <img src="{% static 'images/settings.svg' %}" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        </button>
        <a href="{% url 'users:logout' %}" class="profile-icon-btn btn-logout" aria-label="–í—ã–π—Ç–∏">
          <img src="{% static 'images/sign-out-alt.svg' %}" alt="–í—ã–π—Ç–∏">
        </a>
      </div>
    </div>

    <div class="profile-sheet" data-profile-settings>
      <div class="profile-sheet__handle"></div>
      <div class="profile-sheet__header">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
        <button class="profile-sheet__close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å" data-profile-settings-close>‚úï</button>
      </div>
      <form class="profile-sheet__form" method="post" action="{% url 'users:profile_update' %}"
        enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        <label class="profile-sheet__field">
          <span>–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</span>
          <div class="profile-sheet__avatar-row">
            <div class="profile-sheet__avatar">
              {% if request.user.is_authenticated and request.user.avatar %}
              <img src="{{ request.user.avatar.url }}"
                alt="{{ request.user.get_full_name|default:request.user.username }}">
              {% else %}
              <img src="{% static 'images/zaglushka.png' %}" alt="–ê–≤–∞—Ç–∞—Ä">
              {% endif %}
            </div>
            <label class="profile-sheet__upload">
              <input type="file" name="avatar" accept="image/*">
              <span>–î–æ–±–∞–≤–∏—Ç—å / –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</span>
            </label>
          </div>
        </label>

        <label class="profile-sheet__field">
          <span>–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è</span>
          <input type="text" name="full_name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è"
            value="{% if request.user.is_authenticated %}{{ request.user.get_full_name|default:request.user.username }}{% endif %}">
        </label>

        <label class="profile-sheet__field">
          <span>Email</span>
          <input type="email" name="email"
            value="{% if request.user.is_authenticated %}{{ request.user.email }}{% endif %}" readonly
            class="profile-sheet__input--readonly">
        </label>

        <div class="profile-sheet__actions">
          <button type="submit" class="btn-primary profile-sheet__save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn-secondary profile-sheet__cancel" data-profile-settings-close>–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
    <div class="profile-sheet__backdrop" data-profile-settings-backdrop></div>

    <div class="profile-search">
      <input type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–∫–∞–∑–∞–º, —Ç–æ–≤–∞—Ä–∞–º..." aria-label="–ü–æ–∏—Å–∫">
    </div>

    <div class="profile-stats">
      <div class="profile-stat-card">
        <div class="profile-stat__icon">üì¶</div>
        <div>
          <div class="profile-stat__value">
            {% if request.user.is_authenticated %}
            {{ orders_total|default:0 }}
            {% else %}
            0
            {% endif %}
          </div>
          <div class="profile-stat__label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
        </div>
      </div>
      <div class="profile-stat-card">
        <div class="profile-stat__icon">ü™ô</div>
        <div>
          <div class="profile-stat__value">
            {% if request.user.is_authenticated %}
            {{ request.user.loyalty_points|default:0 }}
            {% else %}
            0
            {% endif %}
          </div>
          <div class="profile-stat__label">–ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã</div>
        </div>
      </div>
      <div class="profile-stat-card">
        <div class="profile-stat__icon">%</div>
        <div>
          <div class="profile-stat__value">
            {% if request.user.is_authenticated %}
            {{ request.user.discount_percent|default:15 }}%
            {% else %}
            15%
            {% endif %}
          </div>
          <div class="profile-stat__label">–í–∞—à–∞ —Å–∫–∏–¥–∫–∞</div>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <div class="profile-section__header">
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h3>
        <a href="#" class="profile-link">–í—Å–µ –∑–∞–∫–∞–∑—ã ({{ orders_total }})</a>
      </div>
      <div class="profile-orders">
        {% if orders %}
        {% for order in orders %}
        <article class="order-card">
          <div class="order-card__info">
            {% static 'images/zaglushka.png' as zaglushka_url %}
            <div class="order-card__icon">
              {% if order.items.first.product.get_main_image_url %}
              <img src="{{ order.items.first.product.get_main_image_url }}" alt=""
                onerror="this.onerror=null;this.src='{{ zaglushka_url }}';">
              {% elif order.items.first.product.brand_ref and order.items.first.product.brand_ref.logo %}
              <img src="{{ order.items.first.product.brand_ref.logo.url }}" alt="" class="product-brand-placeholder"
                onerror="this.onerror=null;this.src='{{ zaglushka_url }}';">
              {% else %}
              <img src="{{ zaglushka_url }}" alt="" class="product-brand-placeholder"
                style="padding: 10px; opacity: 0.8;">
              {% endif %}
            </div>
            <div>
              <div class="order-card__title">–ó–∞–∫–∞–∑ #{{ order.id|stringformat:"06d" }}</div>
              <div class="order-card__date">{{ order.created_at|date:"d E Y" }}</div>
            </div>
          </div>
          <div class="order-card__meta">
            <div class="order-card__price">{{ order.total_price|floatformat:0 }} ‚Ç∏</div>
          </div>
        </article>
        {% endfor %}
        {% else %}
        <p style="text-align: center; padding: 20px; color: #666;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
        {% endif %}
      </div>
    </div>



    <div class="profile-section">
      <div class="profile-section__header">
        <h3>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º</h3>
        <a href="{% url 'catalog:home' %}" class="profile-link">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</a>
      </div>
      <div class="product-slider-wrapper">
        <button class="slider-arrow slider-prev" aria-label="–ù–∞–∑–∞–¥">&#10094;</button>
        <div class="product-slider-track">
          {% for product in recommended_products %}
          <article class="product-card">
            <a href="{% url 'catalog:detail' product.slug %}" style="text-decoration: none; color: inherit;">
              {% static 'images/zaglushka.png' as zaglushka_url %}
              <div class="product-thumb">
                {% if product.is_sold_out %}
                <span class="product-tag product-tag--sold">Soldout</span>
                {% else %}
                {% with product_collections=product.collections.all %}
                {% if product_collections %}
                <div class="product-tag-stack">
                  {% for col in product_collections %}
                  <span class="product-tag" style="background-color: {{ col.color }};">{{ col.name }}</span>
                  {% endfor %}
                </div>
                {% endif %}
                {% endwith %}
                {% endif %}
                {% if product.get_main_image_url %}
                <img src="{{ product.get_main_image_url }}" alt="{{ product.title }}"
                  onerror="this.onerror=null;this.src='{{ zaglushka_url }}';" loading="lazy">
                {% elif product.brand_ref and product.brand_ref.logo %}
                <img src="{{ product.brand_ref.logo.url }}" alt="{{ product.title }}" class="product-brand-placeholder"
                  onerror="this.onerror=null;this.src='{{ zaglushka_url }}';" loading="lazy">
                {% else %}
                <img src="{{ zaglushka_url }}" alt="{{ product.title }}" class="product-brand-placeholder"
                  style="padding: 40px; opacity: 0.8;" loading="lazy">
                {% endif %}
              </div>
              <div class="product-info">
                <div class="product-row">
                  <h3 class="product-name">{{ product.title|upper }}</h3>
                  <span class="product-price">
                    {% if product.has_discount %}
                    <span class="product-price-old">{{ product.price|floatformat:0 }}‚Ç∏</span>
                    <span class="product-price-new">{{ product.final_price|floatformat:0 }}‚Ç∏</span>
                    {% else %}
                    {{ product.price|floatformat:0 }}‚Ç∏
                    {% endif %}
                  </span>
                </div>
                <p class="product-subtitle">{{ product.metal|default:product.category.name }}</p>
              </div>
            </a>
          </article>
          {% endfor %}
        </div>
        <button class="slider-arrow slider-next" aria-label="–í–ø–µ—Ä–µ–¥">&#10095;</button>
      </div>
    </div>
  </div>
</section>

{% endblock %}
