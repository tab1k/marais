{% extends 'base.html' %}
{% load static %}

{% block title %}MARAIS — украшения{% endblock %}

{% block content %}

<section class="product-detail">
  <div class="container-m">
    <a href="{% url 'catalog:home' %}" class="back-link">
      <img src="{% static 'images/arrow_back.png' %}" alt="">
      <span>Назад</span>
    </a>

    <div class="detail-layout">
      <div class="detail-gallery">
        <div class="gallery-main" id="mobileGallery">
          <!-- Main Image -->
          {% if product.get_main_image_url %}
          <img src="{{ product.get_main_image_url }}" alt="{{ product.title }}" data-gallery-main
            class="gallery-item active" onerror='this.onerror=null;this.src="{% static ' images/logo.png' %}";'>
          {% elif product.brand_ref and product.brand_ref.logo %}
          <img src="{{ product.brand_ref.logo.url }}" alt="{{ product.title }}" data-gallery-main
            class="product-brand-placeholder gallery-item active"
            onerror="this.onerror=null;this.src='{% static 'images/logo.png' %}';">
          {% else %}
          <img src="{% static 'images/logo.png' %}" alt="{{ product.title }}" data-gallery-main
            class="product-brand-placeholder gallery-item active" style="padding: 40px; opacity: 0.8;">
          {% endif %}

          <!-- Additional Images (visible on mobile scroll) -->
          {% for img in product.images.all %}
          {% if img.get_image_url and img.get_image_url != product.get_main_image_url %}
          <img src="{{ img.get_image_url }}" alt="{{ img.alt }}" class="gallery-item"
            onerror='this.onerror=null;this.src="{% static ' images/logo.png' %}";'>
          {% endif %}
          {% endfor %}
        </div>

        <!-- Dots for mobile slider -->
        <div class="gallery-dots" id="galleryDots">
          <span class="dot active"></span>
          {% for img in product.images.all %}
          <span class="dot"></span>
          {% endfor %}
        </div>

        <div class="gallery-thumbs" data-gallery-thumbs>
          {% if product.get_main_image_url %}
          <button type="button" class="thumb active" data-gallery-src="{{ product.get_main_image_url }}"
            aria-label="Main">
            <img src="{{ product.get_main_image_url }}" alt="Main"
              onerror="this.onerror=null;this.src='{% static 'images/logo.png' %}';">
          </button>
          {% endif %}
          {% for img in product.images.all %}
          {% if img.get_image_url %}
          <button type="button" class="thumb" data-gallery-src="{{ img.get_image_url }}" aria-label="{{ img.alt }}">
            <img src="{{ img.get_image_url }}" alt="{{ img.alt }}"
              onerror="this.onerror=null;this.src='{% static 'images/logo.png' %}';">
          </button>
          {% endif %}
          {% endfor %}
        </div>
      </div>

      <div class="detail-info">
        <h1 class="detail-title">{{ product.title }}</h1>
        <h3 class="detail-price">{{ product.price|floatformat:0 }} ₸</h1>
          <p class="detail-subtitle">{{ product.brand_ref.name|default:product.metal }}</p>

          <p class="detail-description">
            {{ product.description|linebreaks }}
          </p>

          <div class="detail-specs">
            {% if product.collection %}
            <div class="spec-row">
              <span class="spec-label">Коллекция:</span>
              <span class="spec-value">{{ product.collection.name }}</span>
            </div>
            {% endif %}

            {% if product.metal %}
            <div class="spec-row">
              <span class="spec-label">Металл:</span>
              <span class="spec-value">{{ product.metal }}</span>
            </div>
            {% endif %}

            {% if product.material %}
            <div class="spec-row">
              <span class="spec-label">Материал:</span>
              <span class="spec-value">{{ product.material }}</span>
            </div>
            {% endif %}

            {% if product.coverage %}
            <div class="spec-row">
              <span class="spec-label">Покрытие:</span>
              <span class="spec-value">{{ product.coverage }}</span>
            </div>
            {% endif %}

            {% if product.stones %}
            <div class="spec-row">
              <span class="spec-label">Камни:</span>
              <span class="spec-value">{{ product.stones }}</span>
            </div>
            {% endif %}

            {% if product.color %}
            <div class="spec-row">
              <span class="spec-label">Цвет:</span>
              <span class="spec-value">{{ product.color }}</span>
            </div>
            {% endif %}
          </div>

          {% if sizes_list %}
          <div class="detail-meta">
            <h4>Размер</h4>
            <div class="size-options">
              {% for size_val in sizes_list %}
              <button class="size-btn {% if forloop.first %}active{% endif %}">{{ size_val }}</button>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if product.related_colors.exists %}
          <div class="detail-meta">
            <h4>Варианты</h4>
            <div class="swatch-list">
              <!-- Current product (active) -->
              <a href="javascript:void(0)" class="swatch active" title="{{ product.title }}">
                {% if product.get_main_image_url %}
                <img src="{{ product.get_main_image_url }}" alt="{{ product.title }}">
                {% else %}
                <img src="{% static 'images/product-placeholder.svg' %}" alt="{{ product.title }}">
                {% endif %}
              </a>

              <!-- Related variants -->
              {% for variant in product.related_colors.all %}
              <a href="{% url 'catalog:detail' variant.slug %}" class="swatch" title="{{ variant.title }}">
                {% if variant.get_main_image_url %}
                <img src="{{ variant.get_main_image_url }}" alt="{{ variant.title }}"
                  onerror="this.onerror=null;this.src='{% static 'images/logo.png' %}';">
                {% elif variant.brand_ref and variant.brand_ref.logo %}
                <img src="{{ variant.brand_ref.logo.url }}" alt="{{ variant.title }}" class="product-brand-placeholder"
                  onerror="this.onerror=null;this.src='{% static 'images/logo.png' %}';">
                {% else %}
                <img src="{% static 'images/logo.png' %}" alt="{{ variant.title }}" class="product-brand-placeholder"
                  style="padding: 4px; opacity: 0.8;">
                {% endif %}
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <div class="detail-actions">
            <form action="{% url 'basket:add' product.slug %}" method="post">
              {% csrf_token %}
              <input type="hidden" name="size" id="selected-size" value="{{ sizes_list.0|default:'' }}">
              <button class="btn-primary cart-btn" type="submit">В корзину</button>
            </form>
            <a href="https://wa.me/message/CLSRMWNCKRLJO1" target="_blank" class="btn-secondary outline-btn"
              style="text-decoration: none; display: flex; align-items: center; justify-content: center;">Консультант</a>
          </div>

          <details class="cart-info">
            <summary>Информация о доставке</summary>
            <div class="cart-info__body">
              <p>Мы отправляем заказы из Алматы. В обычные дни оформление и передача в доставку занимает один день. В
                период акций и праздников обработка может занять немного больше времени.</p>
              <p>Доставка по Казахстану и в другие страны осуществляется через транспортные компании.</p>
              <p>Срок зависит от вашего города и выбранного способа доставки. По Казахстану доставка обычно занимает до
                4 рабочих дней. Для заказов от 300 000 ₸ доставка по Казахстану бесплатная.</p>
              <ul class="cart-info__list">
                <li>Бесплатная доставка при заказе от 300 000 ₸</li>
                <li>Оплата с любого банка</li>
                <li>Подарочная упаковка доступна</li>
              </ul>
            </div>
          </details>

      </div>
    </div>
  </div>
</section>

<section class="related-section">
  <div class="container-m">
    <div class="slider-header">
      <h2 class="related-title">Вам также может понравиться</h2>
      <div class="slider-nav">
        <button class="slider-arrow slider-prev" aria-label="Назад">‹</button>
        <button class="slider-arrow slider-next" aria-label="Вперед">›</button>
      </div>
    </div>
    {% if related_products %}
    <div class="product-slider-wrapper">
      <div class="product-slider-track">
        {% for rel_prod in related_products %}
        <a class="product-card" href="{% url 'catalog:detail' rel_prod.slug %}"
          style="text-decoration:none; color:inherit;">
          <div class="product-thumb">
            {% if rel_prod.get_main_image_url %}
            <img src="{{ rel_prod.get_main_image_url }}" alt="{{ rel_prod.title }}"
              onerror="this.onerror=null;this.src='{% static 'images/zaglushka.png' %}';">
            {% elif rel_prod.brand_ref and rel_prod.brand_ref.logo %}
            <img src="{% static 'images/zaglushka.png' %}" alt="{{ rel_prod.title }}"
              onerror="this.onerror=null;this.src='{% static 'images/zaglushka.png' %}';">
            {% else %}
            <img src="{% static 'images/zaglushka.png' %}" alt="{{ rel_prod.title }}" style="padding: 40px; opacity: 0.8;">
            {% endif %}
          </div>
          <div class="product-info">
            <div class="product-row">
              <h3 class="product-name">{{ rel_prod.title }}</h3>
              <span class="product-price">{{ rel_prod.price|floatformat:0 }}₸</span>
            </div>
            <p class="product-subtitle">{{ rel_prod.brand_ref.name|default:rel_prod.metal }}</p>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <p>Нет похожих товаров.</p>
    {% endif %}
  </div>
</section>

<section class="related-section">
  <div class="container-m">
    <div class="slider-header">
      <h2 class="related-title">Завершите образ</h2>
      <div class="slider-nav">
        <button class="slider-arrow slider-prev" aria-label="Назад">‹</button>
        <button class="slider-arrow slider-next" aria-label="Вперед">›</button>
      </div>
    </div>
    {% if complementary_products %}
    <div class="product-slider-wrapper">
      <div class="product-slider-track">
        {% for comp_product in complementary_products %}
        <article class="product-card">
          <a href="{% url 'catalog:detail' comp_product.slug %}" style="text-decoration: none; color: inherit;">
            <div class="product-thumb">
              {% if comp_product.get_main_image_url %}
              <img src="{{ comp_product.get_main_image_url }}" alt="{{ comp_product.title }}"
                onerror="this.onerror=null;this.src='{% static 'images/logo.png' %}';">
              {% elif comp_product.brand_ref and comp_product.brand_ref.logo %}
              <img src="{% static 'images/zaglushka.png' %}" alt="{{ comp_product.title }}"
                onerror="this.onerror=null;this.src='{% static 'images/zaglushka.png' %}';">
              {% else %}
              <img src="{% static 'images/zaglushka.png' %}" alt="{{ comp_product.title }}"
                style="padding: 40px; opacity: 0.8;">
              {% endif %}
            </div>
            <div class="product-info">
              <div class="product-row">
                <h3 class="product-name">{{ comp_product.title|upper }}</h3>
                <span class="product-price">{{ comp_product.price|floatformat:0 }}₸</span>
              </div>
              <p class="product-subtitle">{{ comp_product.metal|default:comp_product.category.name }}</p>
            </div>
          </a>
        </article>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <p>Нет дополнительных товаров.</p>
    {% endif %}
  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sizeBtns = document.querySelectorAll('.size-btn');
    const sizeInput = document.getElementById('selected-size');

    sizeBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        // Remove active class from all
        sizeBtns.forEach(b => b.classList.remove('active'));
        // Add active to current
        this.classList.add('active');
        // Update input value
        if (sizeInput) {
          sizeInput.value = this.textContent.trim();
        }
      });
    });

    // Slider Navigation Arrows
    document.querySelectorAll('.slider-header').forEach(header => {
      const section = header.closest('.related-section');
      const track = section.querySelector('.product-slider-track');
      const prevBtn = header.querySelector('.slider-prev');
      const nextBtn = header.querySelector('.slider-next');

      if (track && prevBtn && nextBtn) {
        const scrollAmount = 300;

        prevBtn.addEventListener('click', () => {
          track.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        });

        nextBtn.addEventListener('click', () => {
          track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        });
      }
    });
  });
</script>


<!-- Lightbox Modal -->
<div class="lightbox" id="productLightbox">
  <button class="lightbox-close" aria-label="Close">&times;</button>
  <button class="lightbox-prev" aria-label="Previous">&#10094;</button>
  <div class="lightbox-content">
    <img src="" alt="" class="lightbox-img">
  </div>
  <button class="lightbox-next" aria-label="Next">&#10095;</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const lightbox = document.getElementById('productLightbox');
    const lightboxImg = lightbox.querySelector('.lightbox-img');
    const closeBtn = lightbox.querySelector('.lightbox-close');
    const prevBtn = lightbox.querySelector('.lightbox-prev');
    const nextBtn = lightbox.querySelector('.lightbox-next');
    const mainImage = document.querySelector('[data-gallery-main]');

    // Collect all images (main + thumbnails)
    let images = [];

    // Add main image first
    if (mainImage) {
      images.push(mainImage.src);
    }

    // Add thumbnails
    const thumbs = document.querySelectorAll('[data-gallery-src]');
    thumbs.forEach(thumb => {
      // Avoid duplicates if main image is also a thumb
      if (!images.includes(thumb.getAttribute('data-gallery-src'))) {
        images.push(thumb.getAttribute('data-gallery-src'));
      }
    });

    let currentIndex = 0;

    function openLightbox(index) {
      if (images.length === 0) return;
      currentIndex = index;
      lightboxImg.src = images[currentIndex];
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden'; // Disable scroll
    }

    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = ''; // Enable scroll
    }

    function showNext() {
      currentIndex = (currentIndex + 1) % images.length;
      lightboxImg.src = images[currentIndex];
    }

    function showPrev() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      lightboxImg.src = images[currentIndex];
    }

    // Event Listeners
    if (mainImage) {
      mainImage.style.cursor = 'zoom-in';
      mainImage.addEventListener('click', () => openLightbox(0));
    }

    closeBtn.addEventListener('click', closeLightbox);
    nextBtn.addEventListener('click', showNext);
    prevBtn.addEventListener('click', showPrev);

    // Close on background click
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('active')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowRight') showNext();
      if (e.key === 'ArrowLeft') showPrev();
    });
  });


  // Mobile Gallery Dots
  document.addEventListener('DOMContentLoaded', function () {
    const gallery = document.getElementById('mobileGallery');
    const dots = document.querySelectorAll('.gallery-dots .dot');

    if (gallery && dots.length > 0) {
      gallery.addEventListener('scroll', function () {
        // Calculate current index based on scroll position
        const scrollLeft = gallery.scrollLeft;
        const itemWidth = gallery.clientWidth;
        const index = Math.round(scrollLeft / itemWidth);

        // Update active dot
        dots.forEach((dot, i) => {
          if (i === index) {
            dot.classList.add('active');
          } else {
            dot.classList.remove('active');
          }
        });
      });
    }
  });

  // Desktop Gallery Switcher
  document.addEventListener('DOMContentLoaded', function () {
    const thumbs = document.querySelectorAll('.gallery-thumbs .thumb');
    const galleryItems = document.querySelectorAll('.gallery-item');

    thumbs.forEach(thumb => {
      thumb.addEventListener('click', function () {
        // Update active thumb
        thumbs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Update active main image
        const src = this.getAttribute('data-gallery-src');
        galleryItems.forEach(item => {
          if (item.src.includes(src) || item.getAttribute('src') === src) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
      });
    });
  });
</script>
{% endblock %}