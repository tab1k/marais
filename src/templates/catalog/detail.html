{% extends 'base.html' %}
{% load static %}

{% block title %}MARAIS — украшения{% endblock %}

{% block content %}

<section class="product-detail">
  <div class="container-m">
    <a href="{% url 'catalog:home' %}" class="back-link">
      <img src="{% static 'images/arrow_back.png' %}" alt="">
      <span>Назад</span>
    </a>

    <div class="detail-layout">
      <div class="detail-gallery">
        <div class="gallery-main">
          {% if product.main_image %}
          <img src="{{ product.main_image.url }}" alt="{{ product.title }}" data-gallery-main>
          {% elif product.brand_ref and product.brand_ref.logo %}
          <img src="{{ product.brand_ref.logo.url }}" alt="{{ product.title }}" data-gallery-main
            class="product-brand-placeholder">
          {% else %}
          <img src="{% static 'images/logo.png' %}" alt="{{ product.title }}" data-gallery-main
            class="product-brand-placeholder" style="padding: 40px; opacity: 0.8;">
          {% endif %}
        </div>
        <div class="gallery-thumbs" data-gallery-thumbs>
          {% if product.main_image %}
          <button type="button" class="thumb active" data-gallery-src="{{ product.main_image.url }}" aria-label="Main">
            <img src="{{ product.main_image.url }}" alt="Main">
          </button>
          {% endif %}
          {% for img in product.images.all %}
          <button type="button" class="thumb" data-gallery-src="{{ img.image.url }}" aria-label="{{ img.alt }}">
            <img src="{{ img.image.url }}" alt="{{ img.alt }}">
          </button>
          {% endfor %}
        </div>
      </div>

      <div class="detail-info">
        <h1 class="detail-title">{{ product.title }}</h1>
        <h3 class="detail-price">{{ product.price|floatformat:0 }} ₸</h1>
          <p class="detail-subtitle">{{ product.brand_ref.name|default:product.metal }}</p>

          <p class="detail-description">
            {{ product.description|linebreaks }}
          </p>

          {% if sizes_list %}
          <div class="detail-meta">
            <h4>Размер</h4>
            <div class="size-options">
              {% for size_val in sizes_list %}
              <button class="size-btn {% if forloop.first %}active{% endif %}">{{ size_val }}</button>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if product.related_colors.exists %}
          <div class="detail-meta">
            <h4>Варианты</h4>
            <div class="swatch-list">
              <!-- Current product (active) -->
              <a href="javascript:void(0)" class="swatch active" title="{{ product.title }}">
                {% if product.main_image %}
                <img src="{{ product.main_image.url }}" alt="{{ product.title }}">
                {% else %}
                <img src="{% static 'images/product-placeholder.svg' %}" alt="{{ product.title }}">
                {% endif %}
              </a>

              <!-- Related variants -->
              {% for variant in product.related_colors.all %}
              <a href="{% url 'catalog:detail' variant.slug %}" class="swatch" title="{{ variant.title }}">
                {% if variant.main_image %}
                <img src="{{ variant.main_image.url }}" alt="{{ variant.title }}">
                {% elif variant.brand_ref and variant.brand_ref.logo %}
                <img src="{{ variant.brand_ref.logo.url }}" alt="{{ variant.title }}" class="product-brand-placeholder">
                {% else %}
                <img src="{% static 'images/logo.png' %}" alt="{{ variant.title }}" class="product-brand-placeholder"
                  style="padding: 4px; opacity: 0.8;">
                {% endif %}
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <div class="detail-actions">
            <form action="{% url 'basket:add' product.slug %}" method="post">
              {% csrf_token %}
              <input type="hidden" name="size" id="selected-size" value="{{ sizes_list.0|default:'' }}">
              <button class="btn-primary cart-btn" type="submit">В корзину</button>
            </form>
            <a href="https://wa.me/message/CLSRMWNCKRLJO1" target="_blank" class="btn-secondary outline-btn"
              style="text-decoration: none; display: flex; align-items: center; justify-content: center;">Консультант</a>
          </div>

          <details class="cart-info" style="margin-top: 20px; border-top: 1px solid #e6e1da; padding-top: 10px;">
            <summary>Информация о доставке</summary>
            <div class="cart-info__body">
              <p>Мы отправляем заказы из Алматы. В обычные дни оформление и передача в доставку занимает один день. В
                период акций и праздников обработка может занять немного больше времени.</p>
              <p>Доставка по Казахстану и в другие страны осуществляется через транспортные компании.</p>
              <p>Срок зависит от вашего города и выбранного способа доставки. По Казахстану доставка обычно занимает до
                4
                рабочих дней. Для заказов от 300 000 ₸ доставка по Казахстану бесплатная.</p>
              <ul class="cart-info__list">
                <li>Бесплатная доставка при заказе от 100 000 ₸</li>
                <li>Оплата с любого банка</li>
                <li>Подарочная упаковка доступна</li>
                <li>Бесплатная годовая гарантия</li>
              </ul>
            </div>
          </details>
      </div>
    </div>
  </div>
</section>

<section class="related-section">
  <div class="container-m">
    <h2 class="related-title">Вам также может понравиться</h2>
    {% if related_products %}
    <div class="product-slider-wrapper">
      <button class="slider-arrow slider-prev" aria-label="Назад">&#10094;</button>
      <div class="product-slider-track">
        {% for rel_prod in related_products %}
        <a class="product-card" href="{% url 'catalog:detail' rel_prod.slug %}"
          style="text-decoration:none; color:inherit;">
          <div class="product-thumb">
            {% if rel_prod.main_image %}
            <img src="{{ rel_prod.main_image.url }}" alt="{{ rel_prod.title }}">
            {% elif rel_prod.brand_ref and rel_prod.brand_ref.logo %}
            <img src="{{ rel_prod.brand_ref.logo.url }}" alt="{{ rel_prod.title }}" class="product-brand-placeholder">
            {% else %}
            <img src="{% static 'images/logo.png' %}" alt="{{ rel_prod.title }}" class="product-brand-placeholder"
              style="padding: 40px; opacity: 0.8;">
            {% endif %}
          </div>
          <div class="product-info">
            <div class="product-row">
              <h3 class="product-name">{{ rel_prod.title }}</h3>
              <span class="product-price">{{ rel_prod.price|floatformat:0 }}₸</span>
            </div>
            <p class="product-subtitle">{{ rel_prod.brand_ref.name|default:rel_prod.metal }}</p>
          </div>
        </a>
        {% endfor %}
      </div>
      <button class="slider-arrow slider-next" aria-label="Вперед">&#10095;</button>
    </div>
    {% else %}
    <p>Нет похожих товаров.</p>
    {% endif %}
  </div>
</section>

<section class="related-section">
  <div class="container-m">
    <h2 class="related-title">Завершите образ</h2>
    {% if complementary_products %}
    <div class="product-slider-wrapper">
      <button class="slider-arrow slider-prev" aria-label="Назад">&#10094;</button>
      <div class="product-slider-track">
        {% for comp_product in complementary_products %}
        <article class="product-card">
          <a href="{% url 'catalog:detail' comp_product.slug %}" style="text-decoration: none; color: inherit;">
            <div class="product-thumb">
              {% if comp_product.main_image %}
              <img src="{{ comp_product.main_image.url }}" alt="{{ comp_product.title }}">
              {% elif comp_product.brand_ref and comp_product.brand_ref.logo %}
              <img src="{{ comp_product.brand_ref.logo.url }}" alt="{{ comp_product.title }}"
                class="product-brand-placeholder">
              {% else %}
              <img src="{% static 'images/logo.png' %}" alt="{{ comp_product.title }}" class="product-brand-placeholder"
                style="padding: 40px; opacity: 0.8;">
              {% endif %}
            </div>
            <div class="product-info">
              <div class="product-row">
                <h3 class="product-name">{{ comp_product.title|upper }}</h3>
                <span class="product-price">{{ comp_product.price|floatformat:0 }}₸</span>
              </div>
              <p class="product-subtitle">{{ comp_product.metal|default:comp_product.category.name }}</p>
            </div>
          </a>
        </article>
        {% endfor %}
      </div>
      <button class="slider-arrow slider-next" aria-label="Вперед">&#10095;</button>
    </div>
    {% else %}
    <p>Нет дополнительных товаров.</p>
    {% endif %}
  </div>
</section>

<!-- Image Modal -->
<div class="image-modal" data-image-modal>
  <button class="image-modal-close" data-image-modal-close>&times;</button>
  <img src="" alt="Full view" class="image-modal-img" data-image-modal-img>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sizeBtns = document.querySelectorAll('.size-btn');
    const sizeInput = document.getElementById('selected-size');

    sizeBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        // Remove active class from all
        sizeBtns.forEach(b => b.classList.remove('active'));
        // Add active to current
        this.classList.add('active');
        // Update input value
        if (sizeInput) {
          sizeInput.value = this.textContent.trim();
        }
      });
    });
  });
</script>
{% endblock %}