{% extends 'base.html' %}
{% load static %}
{% load catalog_tags %}

{% block title %}MARAIS — украшения{% endblock %}

{% block content %}

<section class="catalog-page">
  <div class="container-m">
    <div class="catalog-layout">
      <aside class="filter-panel" data-filter-panel>
        <div class="filter-header">
          <h4 class="filter-title">Фильтр</h4>
          <button class="filter-close" type="button" data-filter-close aria-label="Закрыть фильтр">✕</button>
        </div>

        <div class="filter-group" style="padding-top: 5px;">
          <a href="{% url 'catalog:home' %}" class="filter-clear-all">Сбросить все</a>
        </div>

        <div class="filter-group active" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Категории</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for cat in categories %}
              <a href="?{% if cat.slug in selected_categories %}{% url_replace category=None %}{% else %}{% url_replace category=cat.slug %}{% endif %}"
                class="filter-link {% if cat.slug in selected_categories %}active{% endif %}">
                {{ cat.name }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>

        {% if available_sizes %}
        <div class="filter-group {% if selected_sizes %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Размер</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-sizes-grid">
              {% for s in available_sizes %}
              <a href="?{% if s in selected_sizes %}{% url_replace size=None %}{% else %}{% url_replace size=s %}{% endif %}"
                class="filter-size-btn {% if s in selected_sizes %}active{% endif %}">
                {{ s }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        <div class="filter-group {% if selected_brands %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Бренды</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for brand in brands %}
              <a href="?{% if brand.name in selected_brands %}{% url_replace brand=None %}{% else %}{% url_replace brand=brand.name %}{% endif %}"
                class="filter-link {% if brand.name in selected_brands %}active{% endif %}">
                {{ brand.name }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>

      </aside>
      <div class="filter-backdrop" data-filter-backdrop></div>

      <style>
        .filter-options-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .filter-link {
          text-decoration: none;
          color: #333;
          font-size: 16px;
          transition: color 0.2s;
          cursor: pointer;
        }

        .filter-link:hover {
          color: #a71930;
        }

        .filter-link.active {
          font-weight: 500;
          color: #a71930;
        }

        .filter-group-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          cursor: pointer;
          padding: 8px 0;
        }

        .filter-group-title {
          font-size: 14px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          margin: 0;
        }

        .filter-chevron {
          width: 8px;
          height: 8px;
          border-right: 1.5px solid #333;
          border-bottom: 1.5px solid #333;
          transform: rotate(45deg);
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          margin-right: 4px;
          margin-top: -4px;
        }

        .filter-group.active .filter-chevron {
          transform: rotate(-135deg);
          margin-top: 4px;
        }

        .filter-group-content {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), padding 0.3s ease, margin 0.3s ease;
          opacity: 0;
          pointer-events: none;
        }

        .filter-group.active .filter-group-content {
          max-height: 1000px;
          padding-bottom: 16px;
          margin-top: 8px;
          opacity: 1;
          pointer-events: auto;
        }

        .filter-clear-all {
          display: inline-block;
          font-size: 11px;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.08em;
          color: #333;
          text-decoration: none;
          padding: 8px 16px;
          border: 1px solid #efebe6;
          border-radius: 4px;
          transition: all 0.2s ease;
          width: 100%;
          text-align: center;
          margin-bottom: 10px;
          margin-top: 10px;
        }

        .filter-clear-all:hover {
          background-color: #a71930;
          color: #fff;
          border-color: #a71930;
        }
      </style>

      <div class="catalog-content">
        <div class="catalog-mobile-bar">
          <button class="filter-toggle" type="button" data-filter-toggle>
            <span class="filter-toggle__icon" aria-hidden="true">
              <img src="{% static 'images/filters.png' %}" alt="">
            </span>
            <span style="font-weight: 400;">Фильтр</span>
          </button>
        </div>
        <div class="product-grid">
          {% for product in products %}
          <a class="product-card" href="{% url 'catalog:detail' product.slug %}"
            style="text-decoration: none; color: inherit;">
            <div class="product-thumb">
              {% if product.main_image %}
              <img src="{{ product.main_image.url }}" alt="{{ product.title }}">
              {% elif product.brand_ref and product.brand_ref.logo %}
              <img src="{{ product.brand_ref.logo.url }}" alt="{{ product.title }}" class="product-brand-placeholder">
              {% else %}
              <img src="{% static 'images/logo.png' %}" alt="{{ product.title }}" class="product-brand-placeholder"
                style="padding: 40px; opacity: 0.8;">
              {% endif %}
            </div>
            <div class="product-info">
              <div class="product-row">
                <h3 class="product-name">{{ product.title }}</h3>
                <span class="product-price">{{ product.price|floatformat:0 }} ₸</span>
              </div>
              <p class="product-subtitle">{{ product.brand_ref.name|default:product.metal }}</p>
            </div>
          </a>
          {% empty %}
          <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
            <p>Товары не найдены по выбранным фильтрам.</p>
            <a href="{% url 'catalog:home' %}" class="btn-primary"
              style="margin-top:20px; display:inline-block;">Сбросить фильтры</a>
          </div>
          {% endfor %}
        </div>

        {% if page_obj.paginator.num_pages > 1 %}
        <div class="catalog-pagination">
          {% if page_obj.has_previous %}
          <a class="page-arrow" href="?{% url_replace page=page_obj.previous_page_number %}"
            aria-label="Предыдущая страница">&#10094;</a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <span class="page-link active">{{ num }}</span>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a class="page-link"
            href="?{% url_replace page=num %}">{{ num }}</a>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <a class="page-arrow" href="?{% url_replace page=page_obj.next_page_number %}"
              aria-label="Следующая страница">&#10095;</a>
            {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggles = document.querySelectorAll('[data-collapse-toggle]');
    toggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const group = toggle.closest('[data-collapsible]');
        if (group) {
          group.classList.toggle('active');
        }
      });
    });
  });
</script>

{% endblock %}