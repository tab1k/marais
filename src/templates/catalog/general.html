{% extends 'base.html' %}
{% load static %}
{% load catalog_tags %}

{% block title %}MARAIS — украшения{% endblock %}

{% block content %}

<section class="catalog-page">
  <div class="container-m">
    <div class="catalog-layout">
      <aside class="filter-panel" data-filter-panel>
        <div class="filter-header">
          <h4 class="filter-title">Фильтр</h4>
          <button class="filter-close" type="button" data-filter-close aria-label="Закрыть фильтр">✕</button>
        </div>

        <div class="filter-group" style="padding-top: 5px;">
          <a href="{% url 'catalog:home' %}" class="filter-clear-all">Сбросить все</a>
        </div>

        <div class="filter-group active" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Категории</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for cat in categories %}
              <a href="?{% if cat.slug in selected_categories %}{% url_replace category=None %}{% else %}{% url_replace category=cat.slug %}{% endif %}"
                class="filter-link {% if cat.slug in selected_categories %}active{% endif %}">
                {{ cat.name }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>

        {% if all_collections %}
        <div class="filter-group active" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Коллекции</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for col in all_collections %}
              <a href="?{% if col.slug in selected_collections %}{% url_replace collection=None %}{% else %}{% url_replace collection=col.slug %}{% endif %}"
                class="filter-link {% if col.slug in selected_collections %}active{% endif %}">
                {{ col.name }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if price_min is not None and price_max is not None and price_min != price_max %}
        <div class="filter-group active" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Цена</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="price-filter-container">
              <div class="price-inputs">
                <input type="number" id="price-min-input" class="price-input"
                  value="{{ selected_min_price|default:price_min }}" min="{{ price_min }}" max="{{ price_max }}"
                  step="1000">
                <span class="price-separator">—</span>
                <input type="number" id="price-max-input" class="price-input"
                  value="{{ selected_max_price|default:price_max }}" min="{{ price_min }}" max="{{ price_max }}"
                  step="1000">
              </div>
              <div class="price-slider-wrapper">
                <div class="price-slider-track"></div>
                <div class="price-slider-range" id="price-slider-range"></div>
                <input type="range" id="price-slider-min" class="price-slider" min="{{ price_min }}"
                  max="{{ price_max }}" value="{{ selected_min_price|default:price_min }}" step="1000">
                <input type="range" id="price-slider-max" class="price-slider" min="{{ price_min }}"
                  max="{{ price_max }}" value="{{ selected_max_price|default:price_max }}" step="1000">
              </div>
              <button type="button" class="price-apply-btn" id="price-apply-btn">Применить</button>
            </div>
          </div>
        </div>
        {% endif %}

        {% if available_sizes and selected_categories %}
        <div class="filter-group {% if selected_sizes %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Размер</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-sizes-grid">
              {% for s in available_sizes %}
              <a href="?{% if s in selected_sizes %}{% url_replace size=None %}{% else %}{% url_replace size=s %}{% endif %}"
                class="filter-size-btn {% if s in selected_sizes %}active{% endif %}">
                {{ s }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        <div class="filter-group {% if selected_brands %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Бренды</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for brand in brands %}
              <a href="?{% if brand.name in selected_brands %}{% url_replace brand=None %}{% else %}{% url_replace brand=brand.name %}{% endif %}"
                class="filter-link {% if brand.name in selected_brands %}active{% endif %}">
                {{ brand.name }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>

        {% if available_metals %}
        <div class="filter-group {% if selected_metals %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Металл</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for val in available_metals %}
              <a href="?{% if val in selected_metals %}{% url_replace metal=None %}{% else %}{% url_replace metal=val %}{% endif %}"
                class="filter-link {% if val in selected_metals %}active{% endif %}">
                {{ val }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if available_materials %}
        <div class="filter-group {% if selected_materials %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Материал</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for val in available_materials %}
              <a href="?{% if val in selected_materials %}{% url_replace material=None %}{% else %}{% url_replace material=val %}{% endif %}"
                class="filter-link {% if val in selected_materials %}active{% endif %}">
                {{ val }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if available_stones %}
        <div class="filter-group {% if selected_stones %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Камни</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for val in available_stones %}
              <a href="?{% if val in selected_stones %}{% url_replace stones=None %}{% else %}{% url_replace stones=val %}{% endif %}"
                class="filter-link {% if val in selected_stones %}active{% endif %}">
                {{ val }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if available_coverages %}
        <div class="filter-group {% if selected_coverage %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Покрытие</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for val in available_coverages %}
              <a href="?{% if val in selected_coverage %}{% url_replace coverage=None %}{% else %}{% url_replace coverage=val %}{% endif %}"
                class="filter-link {% if val in selected_coverage %}active{% endif %}">
                {{ val }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if available_colors %}
        <div class="filter-group {% if selected_colors %}active{% endif %}" data-collapsible>
          <div class="filter-group-header" data-collapse-toggle>
            <div class="filter-group-title">Цвет</div>
            <span class="filter-chevron"></span>
          </div>
          <div class="filter-group-content">
            <div class="filter-options-list">
              {% for val in available_colors %}
              <a href="?{% if val in selected_colors %}{% url_replace color=None %}{% else %}{% url_replace color=val %}{% endif %}"
                class="filter-link {% if val in selected_colors %}active{% endif %}">
                {{ val }}
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

      </aside>
      <div class="filter-backdrop" data-filter-backdrop></div>

      <style>
        .filter-options-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .filter-link {
          text-decoration: none;
          color: #333;
          font-size: 16px;
          transition: color 0.2s;
          cursor: pointer;
        }

        .filter-link:hover {
          color: #a71930;
        }

        .filter-link.active {
          font-weight: 500;
          color: #a71930;
        }

        .filter-group-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          cursor: pointer;
          padding: 8px 0;
        }

        .filter-group-title {
          font-size: 14px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          margin: 0;
        }

        .filter-chevron {
          width: 8px;
          height: 8px;
          border-right: 1.5px solid #333;
          border-bottom: 1.5px solid #333;
          transform: rotate(45deg);
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          margin-right: 4px;
          margin-top: -4px;
        }

        .filter-group.active .filter-chevron {
          transform: rotate(-135deg);
          margin-top: 4px;
        }

        .filter-group-content {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), padding 0.3s ease, margin 0.3s ease;
          opacity: 0;
          pointer-events: none;
        }

        .filter-group.active .filter-group-content {
          max-height: 1000px;
          padding-bottom: 16px;
          margin-top: 8px;
          opacity: 1;
          pointer-events: auto;
        }

        .filter-clear-all {
          display: inline-block;
          font-size: 11px;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.08em;
          color: #333;
          text-decoration: none;
          padding: 8px 16px;
          border: 1px solid #efebe6;
          border-radius: 4px;
          transition: all 0.2s ease;
          width: 100%;
          text-align: center;
          margin-bottom: 10px;
          margin-top: 10px;
        }

        .filter-clear-all:hover {
          background-color: #a71930;
          color: #fff;
          border-color: #a71930;
        }

        /* Price Filter Styles */
        .price-filter-container {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .price-inputs {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .price-input {
          flex: 1;
          padding: 8px 12px;
          border: 1px solid #efebe6;
          border-radius: 4px;
          font-size: 14px;
          text-align: center;
          transition: border-color 0.2s;
        }

        .price-input:focus {
          outline: none;
          border-color: #a71930;
        }

        .price-separator {
          color: #999;
          font-weight: 300;
        }

        .price-slider-wrapper {
          position: relative;
          height: 6px;
          margin: 20px 0;
        }

        .price-slider-track {
          position: absolute;
          width: 100%;
          height: 6px;
          background: #efebe6;
          border-radius: 3px;
        }

        .price-slider-range {
          position: absolute;
          height: 6px;
          background: #a71930;
          border-radius: 3px;
          pointer-events: none;
        }

        .price-slider {
          position: absolute;
          width: 100%;
          height: 6px;
          background: transparent;
          pointer-events: none;
          -webkit-appearance: none;
          appearance: none;
        }

        .price-slider::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 18px;
          height: 18px;
          background: #a71930;
          border: 2px solid #fff;
          border-radius: 50%;
          cursor: pointer;
          pointer-events: auto;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          transition: transform 0.2s, box-shadow 0.2s;
        }

        .price-slider::-webkit-slider-thumb:hover {
          transform: scale(1.1);
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .price-slider::-moz-range-thumb {
          width: 18px;
          height: 18px;
          background: #a71930;
          border: 2px solid #fff;
          border-radius: 50%;
          cursor: pointer;
          pointer-events: auto;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          transition: transform 0.2s, box-shadow 0.2s;
        }

        .price-slider::-moz-range-thumb:hover {
          transform: scale(1.1);
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .price-apply-btn {
          padding: 10px 16px;
          background-color: #a71930;
          color: #fff;
          border: none;
          border-radius: 4px;
          font-size: 14px;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          cursor: pointer;
          transition: background-color 0.2s, transform 0.1s;
        }

        .price-apply-btn:hover {
          background-color: #8a1426;
        }

        .price-apply-btn:active {
          transform: scale(0.98);
        }
      </style>

      <div class="catalog-content">
        {% if all_collections %}

        <style>
          .collections-horizontal-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 16px;
            scrollbar-width: thin;
            scrollbar-color: #d8d0c8 transparent;
          }

          .collections-horizontal-list::-webkit-scrollbar {
            height: 4px;
          }

          .collections-horizontal-list::-webkit-scrollbar-thumb {
            background-color: #d8d0c8;
            border-radius: 4px;
          }

          .collection-pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border: 1px solid #efebe6;
            border-radius: 999px;
            font-size: 14px;
            color: #333;
            text-decoration: none;
            white-space: nowrap;
            transition: all 0.2s;
          }

          .collection-pill:hover,
          .collection-pill.active {
            background-color: #a71930;
            color: #fff;
            border-color: #a71930;
          }
        </style>
        {% endif %}
        <div class="catalog-mobile-bar">
          <button class="filter-toggle" type="button" data-filter-toggle>
            <span class="filter-toggle__icon" aria-hidden="true">
              <img src="{% static 'images/filters.png' %}" alt="">
            </span>
            <span style="font-weight: 400;">Фильтр</span>
          </button>

          <div style="position: relative;" id="mobile-collections-container">
            <button class="filter-toggle" type="button" style="gap: 2px;" data-collections-toggle>
              <span style="font-weight: 400;">
                {% with selected_slug=selected_collections.0 %}
                {% if selected_slug %}
                {% for col in all_collections %}
                {% if col.slug == selected_slug %}{{ col.name }}{% endif %}
                {% endfor %}
                {% else %}
                Все
                {% endif %}
                {% endwith %}
              </span>
              <span class="filter-toggle__icon" aria-hidden="true">
                <img src="{% static 'svg/angle-small-down.svg' %}" alt="">
              </span>
            </button>

            <div class="mobile-collections-dropdown" data-collections-dropdown>
              <a href="{% url 'catalog:home' %}{% if selected_brands %}?{% for b in selected_brands %}brand={{ b }}&{% endfor %}{% endif %}"
                class="mobile-collection-item {% if not selected_collections %}active{% endif %}">
                Все
              </a>
              {% for col in all_collections %}
              <a href="?{% if col.slug in selected_collections %}{% url_replace collection=None %}{% else %}{% url_replace collection=col.slug %}{% endif %}"
                class="mobile-collection-item {% if col.slug in selected_collections %}active{% endif %}">
                {{ col.name }}
              </a>
              {% endfor %}
            </div>
          </div>

          <style>
            .mobile-collections-dropdown {
              position: absolute;
              top: 100%;
              right: 0;
              margin-top: 8px;
              background: #fff;
              border: 1px solid #e6e1da;
              border-radius: 8px;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
              min-width: 200px;
              z-index: 100;
              opacity: 0;
              visibility: hidden;
              transform: translateY(-10px);
              transition: all 0.2s ease;
            }

            .mobile-collections-dropdown.is-open {
              opacity: 1;
              visibility: visible;
              transform: translateY(0);
            }

            .mobile-collection-item {
              display: block;
              padding: 12px 16px;
              color: #333;
              text-decoration: none;
              font-size: 14px;
              border-bottom: 1px solid #f5f5f5;
              transition: background 0.2s;
            }

            .mobile-collection-item:last-child {
              border-bottom: none;
            }

            .mobile-collection-item:hover {
              background: #f9f7f5;
            }

            .mobile-collection-item.active {
              color: #a71930;
              font-weight: 500;
              background: #fdf5f6;
            }
          </style>

          <script>
            document.addEventListener('DOMContentLoaded', function () {
              const toggle = document.querySelector('[data-collections-toggle]');
              const dropdown = document.querySelector('[data-collections-dropdown]');
              const container = document.getElementById('mobile-collections-container');

              if (toggle && dropdown) {
                toggle.addEventListener('click', function (e) {
                  e.stopPropagation();
                  dropdown.classList.toggle('is-open');
                });

                document.addEventListener('click', function (e) {
                  if (!container.contains(e.target)) {
                    dropdown.classList.remove('is-open');
                  }
                });
              }
            });
          </script>

        </div>
        <div class="product-grid">
          {% for product in products %}
          <a class="product-card" href="{% url 'catalog:detail' product.slug %}"
            style="text-decoration: none; color: inherit;">
            <div class="product-thumb">
              {% if product.main_image %}
              <img src="{{ product.main_image.url }}" alt="{{ product.title }}"
                onerror="this.onerror=null;this.src='{% static 'images/zaglushka.png' %}';">
              {% elif product.brand_ref and product.brand_ref.logo %}
              <img src="{{ product.brand_ref.logo.url }}" alt="{{ product.title }}" class="product-brand-placeholder"
                onerror="this.onerror=null;this.src='{% static 'images/zaglushka.png' %}';">
              {% else %}
              <img src="{% static 'images/zaglushka.png' %}" alt="{{ product.title }}" class="product-brand-placeholder"
                style="padding: 40px; opacity: 0.8;">
              {% endif %}
            </div>
            <div class="product-info">
              <div class="product-row">
                <h3 class="product-name">{{ product.title }}</h3>
                <span class="product-price">{{ product.price|floatformat:0 }} ₸</span>
              </div>
              <p class="product-subtitle">{{ product.brand_ref.name|default:product.metal }}</p>
            </div>
          </a>
          {% empty %}
          <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
            <p>Товары не найдены по выбранным фильтрам.</p>
            <a href="{% url 'catalog:home' %}" class="btn-primary"
              style="margin-top:20px; display:inline-block;">Сбросить фильтры</a>
          </div>
          {% endfor %}
        </div>

        {% if page_obj.paginator.num_pages > 1 %}
        <div class="catalog-pagination">
          {% if page_obj.has_previous %}
          <a class="page-arrow" href="?{% url_replace page=page_obj.previous_page_number %}"
            aria-label="Предыдущая страница">&#10094;</a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <span class="page-link active">{{ num }}</span>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a class="page-link"
            href="?{% url_replace page=num %}">{{ num }}</a>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <a class="page-arrow" href="?{% url_replace page=page_obj.next_page_number %}"
              aria-label="Следующая страница">&#10095;</a>
            {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Collapsible filter groups
    const toggles = document.querySelectorAll('[data-collapse-toggle]');
    toggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const group = toggle.closest('[data-collapsible]');
        if (group) {
          group.classList.toggle('active');
        }
      });
    });

    // Price slider functionality
    const priceMinSlider = document.getElementById('price-slider-min');
    const priceMaxSlider = document.getElementById('price-slider-max');
    const priceMinInput = document.getElementById('price-min-input');
    const priceMaxInput = document.getElementById('price-max-input');
    const priceRange = document.getElementById('price-slider-range');
    const applyBtn = document.getElementById('price-apply-btn');

    if (priceMinSlider && priceMaxSlider && priceMinInput && priceMaxInput && priceRange && applyBtn) {
      const minPrice = parseInt(priceMinSlider.min);
      const maxPrice = parseInt(priceMaxSlider.max);

      function updateSliderRange() {
        const minVal = parseInt(priceMinSlider.value);
        const maxVal = parseInt(priceMaxSlider.value);
        const percent1 = ((minVal - minPrice) / (maxPrice - minPrice)) * 100;
        const percent2 = ((maxVal - minPrice) / (maxPrice - minPrice)) * 100;
        priceRange.style.left = percent1 + '%';
        priceRange.style.width = (percent2 - percent1) + '%';
      }

      function syncSliderToInput() {
        let minVal = parseInt(priceMinInput.value) || minPrice;
        let maxVal = parseInt(priceMaxInput.value) || maxPrice;

        // Validate and constrain values
        minVal = Math.max(minPrice, Math.min(minVal, maxPrice));
        maxVal = Math.max(minPrice, Math.min(maxVal, maxPrice));

        if (minVal > maxVal) {
          [minVal, maxVal] = [maxVal, minVal];
        }

        priceMinInput.value = minVal;
        priceMaxInput.value = maxVal;
        priceMinSlider.value = minVal;
        priceMaxSlider.value = maxVal;
        updateSliderRange();
      }

      function syncInputToSlider() {
        let minVal = parseInt(priceMinSlider.value);
        let maxVal = parseInt(priceMaxSlider.value);

        // Prevent sliders from crossing
        if (minVal > maxVal - 1000) {
          if (this === priceMinSlider) {
            minVal = maxVal - 1000;
            priceMinSlider.value = minVal;
          } else {
            maxVal = minVal + 1000;
            priceMaxSlider.value = maxVal;
          }
        }

        priceMinInput.value = minVal;
        priceMaxInput.value = maxVal;
        updateSliderRange();
      }

      // Event listeners
      priceMinSlider.addEventListener('input', syncInputToSlider);
      priceMaxSlider.addEventListener('input', syncInputToSlider);
      priceMinInput.addEventListener('input', syncSliderToInput);
      priceMaxInput.addEventListener('input', syncSliderToInput);

      // Apply button - update URL with price parameters
      applyBtn.addEventListener('click', () => {
        const minVal = priceMinInput.value;
        const maxVal = priceMaxInput.value;
        const url = new URL(window.location.href);

        // Only add parameters if they differ from the defaults
        if (minVal && minVal != minPrice) {
          url.searchParams.set('min_price', minVal);
        } else {
          url.searchParams.delete('min_price');
        }

        if (maxVal && maxVal != maxPrice) {
          url.searchParams.set('max_price', maxVal);
        } else {
          url.searchParams.delete('max_price');
        }

        // Reset to page 1 when filtering
        url.searchParams.delete('page');

        window.location.href = url.toString();
      });

      // Initialize slider range on load
      updateSliderRange();
    }
  });
</script>

{% endblock %}